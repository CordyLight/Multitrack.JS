<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Плеер для сайта ТО "Магия дружбы"</title>
    <link rel="stylesheet/less" type="text/css" href="player.less" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/3.9.0/less.min.js"></script>
    <style>
        *[application-name="multitrack-js"] {
            width: 854px;
            height: 480px;
        }
    </style>
</head>

<body>
    <div id="player"></div>
    <script src="multitrack.js"></script>
    <script src="ass.js"></script>
    <script>
        var player;
        less.refresh().then(() => {
            let episodename = "Friendship is Magic, part 1"
            var xhr = new XMLHttpRequest();
            xhr.open('GET', `//bronyru.info/api/episodes/search?query=${encodeURI(episodename)}&size=0`, false);
            xhr.send();
            if (xhr.status == 200) {
                let episodeData = JSON.parse(xhr.responseText).data[0];
                console.log(episodeData)
                let quality = Object(episodeData.videos).sort((a, b) => {
                    a = parseInt(a.quality)
                    b = parseInt(b.quality)
                    if(a > b) return -1;
                    if(a < b) return 1;
                    return 0;
                })

                let videos = []
                for(let qual of quality){
                    videos.push({
                        name: `${qual.quality}p`,
                        path: `${episodeData.path}${qual.quality}.mp4`
                    })
                }
                
                let dubs = Object(episodeData.dubs).sort((a, b) => {
                    a = a.priority
                    b = b.priority
                    if(a > b) return 1;
                    if(a < b) return -1;
                    return 0;
                })

                let audios = []
                for(let dub of dubs){
                    audios.push({
                        name: dub.name.name,
                        path: `${episodeData.path}${dub.name.codeName}.mp4`
                    })
                }

                let sub1 = Object(episodeData.subtitles).sort((a, b) => {
                    a = a.priority
                    b = b.priority
                    if(a > b) return 1;
                    if(a < b) return -1;
                    return 0;
                })

                let subtitles = []
                for(let sub of sub1){
                    subtitles.push({
                        name: sub.name.name,
                        path: `${episodeData.path}${sub.name.codeName}.ass`
                    })
                }

                player = new MultitrackJS("#player", {
                    videos: videos,
                    audios: audios,
                    subtitles: subtitles,
                    placeholder: `${episodeData.path}index.jpg`,
                    title: episodeData.title.rus
                });
            } else {
                alert(xhr.status + ': ' + xhr.statusText);
            }
        });
    </script>
</body>

</html>